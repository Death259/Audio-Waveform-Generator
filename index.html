<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Audio Waveform Generator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Crect x='20' y='40' width='8' height='20' rx='4' fill='white'/%3E%3Crect x='33' y='30' width='8' height='40' rx='4' fill='white'/%3E%3Crect x='46' y='20' width='8' height='60' rx='4' fill='white'/%3E%3Crect x='59' y='35' width='8' height='30' rx='4' fill='white'/%3E%3Crect x='72' y='25' width='8' height='50' rx='4' fill='white'/%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXVkaW8gV2F2ZWZvcm0gR2VuZXJhdG9yIiwic2hvcnRfbmFtZSI6IldhdmVmb3JtIiwiZGVzY3JpcHRpb24iOiJHZW5lcmF0ZSBiZWF1dGlmdWwgd2F2ZWZvcm0gaW1hZ2VzIGZyb20gYXVkaW8gZmlsZXMiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyUyMHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycnMjB2aWV3Qm94PScwJTIwMCUyMDE5MiUyMDE5MiclM0UlM0NkZWZzJTNFJTNDbGluZWFyR3JhZGllbnQlMjBpZD0nZyclMjB4MSUzRCcwJTI1JyUyMHkxJTNEJzAlMjUnJTIweDIlM0QnMTAwJTI1JyUyMHkyJTNEJzEwMCUyNSclM0UlM0NzdG9wJTIwb2Zmc2V0PSclMjAlMjUnJTIwc3R5bGU9J3N0b3AtY29sb3I6JTIzJTIzNjY3ZWVhJy8lM0UlM0NzdG9wJTIwb2Zmc2V0JTNEJzEwMCUyNSclMjBzdHlsZT0nc3RvcC1jb2xvcjolMjMlMjM3NjRiYTInLyUzRSUzQy9saW5lYXJHcmFkaWVudCUzRSUzQy9kZWZzJTNFJTNDcmVjdCUyMHdpZHRoJTNEJzE5MiclMjBoZWlnaHQlM0QnMTkyJyUyMGZpbGwlM0QndXJsKCUyM2cpJy8lM0UlM0N0ZXh0JTIweD0nOTYnJTIweT0nMTIwJyUyMGZvbnQtZmFtaWx5PSdBcmlhbCclMjBmb250LXNpemUlM0QnODAnJTIwZmlsbCUzRCclMjNmZmYnJTIwdGV4dC1hbmNob3IlM0QnbWlkZGxlJyUzRSVGMCU5RiU4RSVCNSUzQy90ZXh0JTNFJTNDJTJmc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIweG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUyMHZpZXdCb3g9JzAlMjAwJTIwNTEyJTIwNTEyJyUzRSUzQ2RlZnMlM0UlM0NsaW5lYXJHcmFkaWVudCUyMGlkPSdnJyUyMHgxJTNEJzAlMjUnJTIweTElM0QnMCUyNSclMjB4MiUzRCcxMDAlMjUnJTIweTIlM0QnMTAwJTI1JyUzRSUzQ3N0b3AlMjBvZmZzZXQ9JyUyMCUyNSclMjBzdHlsZT0nc3RvcC1jb2xvcjolMjMlMjM2NjdlZWEnLyUzRSUzQ3N0b3AlMjBvZmZzZXQlM0QnMTAwJTI1JyUyMHN0eWxlPSdzdG9wLWNvbG9yOiUyMyUyMzc2NGJhMicvJTNFJTNDJTJGbGluZWFyR3JhZGllbnQlM0UlM0MlMkZkZWZzJTNFJTNDcmVjdCUyMHdpZHRoJTNEJzUxMiclMjBoZWlnaHQlM0QnNTEyJyUyMGZpbGwlM0QndXJsKCUyM2cpJy8lM0UlM0N0ZXh0JTIweD0nMjU2JyUyMHklM0QnMzIwJyUyMGZvbnQtZmFtaWx5PSdBcmlhbCclMjBmb250LXNpemUlM0QnMjQwJyUyMGZpbGwlM0QnJTIzZmZmJyUyMHRleHQtYW5jaG9yJTNEJ21pZGRsZSclM0UlRjAlOUYlOEUlQjUlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #667eea;
            --bg-secondary: #764ba2;
            --text-dark: #333;
            --text-light: #666;
            --border: #e0e0e0;
        }
        body.dark-mode {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-dark: #eee;
            --text-light: #aaa;
            --border: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        body.dark-mode .container { background: #1e1e1e; color: var(--text-dark); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        h1 { color: var(--text-dark); font-size: 28px; }
        .subtitle { color: var(--text-light); margin-bottom: 20px; font-size: 14px; }
        .icon-btn {
            background: var(--border);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        .icon-btn:hover { transform: translateY(-2px); }
        body.dark-mode .icon-btn { background: #333; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover { background: rgba(102, 126, 234, 0.1); }
        .upload-area.dragover { background: rgba(102, 126, 234, 0.2); }
        input[type="file"] { display: none; }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px; }
        input[type="color"], input[type="number"], input[type="range"], select {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--text-dark);
        }
        body.dark-mode input, body.dark-mode select { background: #2a2a2a; }
        input[type="color"] { height: 45px; cursor: pointer; }
        input[type="range"] { padding: 0; height: 30px; }
        .canvas-container {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        body.dark-mode .canvas-container { background: #2a2a2a; }
        canvas { width: 100%; display: block; border-radius: 8px; }
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.processing { background: #d1ecf1; color: #0c5460; }
        #customGradient { display: none; margin-bottom: 20px; }
        .gradient-preview {
            height: 40px;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 2px solid var(--border);
        }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            .controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='width: 32px; height: 32px; vertical-align: -6px; margin-right: 8px;'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:#667eea'/><stop offset='100%' style='stop-color:#764ba2'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(#grad)'/><rect x='20' y='40' width='8' height='20' rx='4' fill='white'/><rect x='33' y='30' width='8' height='40' rx='4' fill='white'/><rect x='46' y='20' width='8' height='60' rx='4' fill='white'/><rect x='59' y='35' width='8' height='30' rx='4' fill='white'/><rect x='72' y='25' width='8' height='50' rx='4' fill='white'/></svg>Audio Waveform Generator</h1>
                <p class="subtitle">Create stunning waveform visualizations</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="icon-btn" id="darkBtn" title="Toggle Dark Mode">üåô</button>
                <button class="icon-btn" id="undoBtn" title="Undo" disabled>‚Ü∂</button>
                <button class="icon-btn" id="redoBtn" title="Redo" disabled>‚Ü∑</button>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
            <p><strong>Click to upload</strong> or drag and drop</p>
            <p style="font-size: 12px; color: #999; margin-top: 8px;">MP3, WAV, OGG, M4A supported</p>
            <input type="file" id="audioFile" accept="audio/*">
        </div>

        <div class="status" id="status"></div>

        <div class="controls">
            <div class="control-group">
                <label for="colorMode">Color Mode</label>
                <select id="colorMode">
                    <option value="solid">Solid Color</option>
                    <option value="rainbow">Rainbow</option>
                    <option value="sunset">Sunset</option>
                    <option value="ocean">Ocean</option>
                    <option value="fire">Fire</option>
                    <option value="aqua">Aqua</option>
                    <option value="purpleHaze">Purple Haze</option>
                    <option value="forest">Forest</option>
                    <option value="edm">EDM</option>
                    <option value="redwhiteblue">Red/White/Blue</option>
                    <option value="custom">Custom Gradient</option>
                </select>
            </div>
            <div class="control-group" id="solidColor">
                <label for="waveColor">Waveform Color</label>
                <input type="color" id="waveColor" value="#667eea">
            </div>
            <div class="control-group">
                <label for="bgColor">Background</label>
                <input type="color" id="bgColor" value="#ffffff">
            </div>
            <div class="control-group">
                <label for="width">Width (px)</label>
                <input type="number" id="width" value="1800" min="400" max="4000">
            </div>
            <div class="control-group">
                <label for="height">Height (px)</label>
                <input type="number" id="height" value="400" min="100" max="2000">
            </div>
            <div class="control-group">
                <label for="style">Style</label>
                <select id="style">
                    <option value="bars">Bars</option>
                    <option value="line">Line</option>
                    <option value="mirror">Mirror</option>
                    <option value="roundedBars">Rounded Bars</option>
                    <option value="filled">Filled</option>
                    <option value="particles">Particles</option>
                </select>
            </div>
            <div class="control-group">
                <label for="smoothing">Smoothing: <span id="smoothVal">50</span></label>
                <input type="range" id="smoothing" min="10" max="200" value="50">
            </div>
            <div class="control-group">
                <label for="opacity">Opacity: <span id="opacVal">100</span>%</label>
                <input type="range" id="opacity" min="0" max="100" value="100">
            </div>
        </div>

        <div id="customGradient">
            <h4 style="margin-bottom: 10px; color: var(--text-dark);">Custom Colors (2-5)</h4>
            <div class="controls">
                <div class="control-group"><label>Color 1</label><input type="color" id="c1" value="#667eea"></div>
                <div class="control-group"><label>Color 2</label><input type="color" id="c2" value="#764ba2"></div>
                <div class="control-group"><label>Color 3</label><input type="color" id="c3" value="#f093fb"></div>
                <div class="control-group"><label>Color 4</label><input type="color" id="c4" value="#4facfe"></div>
                <div class="control-group"><label>Color 5</label><input type="color" id="c5" value="#43e97b"></div>
            </div>
            <div style="margin-top: 10px;">
                <label><input type="checkbox" id="use3" checked> Use Color 3</label>
                <label style="margin-left: 15px;"><input type="checkbox" id="use4"> Use Color 4</label>
                <label style="margin-left: 15px;"><input type="checkbox" id="use5"> Use Color 5</label>
            </div>
        </div>

        <div class="gradient-preview" id="preview"></div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas"></canvas>
        </div>

        <button class="btn btn-primary" id="generateBtn" disabled style="margin-bottom: 10px;">üé® Generate Waveform</button>
        <button class="btn btn-primary" id="downloadBtn" disabled style="margin-bottom: 10px;">üíæ Download PNG</button>
        <button class="btn btn-primary" id="copyBtn" disabled>üìã Copy to Clipboard</button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        e.waitUntil(caches.open('waveform-v1').then(c => c.addAll(['/'])));
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(err => {
                    console.log('ServiceWorker registration failed (this is okay):', err);
                });
            });
        }

        const state = { buffer: null, history: [], historyIdx: -1 };
        const presets = {
            rainbow: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'],
            redwhiteblue: ['#b22234', '#ffffff', '#3c3b6e'],
            sunset: ['#ff6b6b', '#feca57', '#ff9ff3', '#54a0ff'],
            ocean: ['#667eea', '#764ba2', '#f093fb', '#4facfe'],
            fire: ['#8B0000', '#FF4500', '#FFA500', '#FFD700'],
            aqua: ['#008B8B', '#00CED1', '#87CEEB'],
            purpleHaze: ['#4B0082', '#8B008B', '#FF1493'],
            forest: ['#013220', '#228B22', '#9ACD32'],
            edm: ['#00FFFF', '#FF00FF', '#FFFF00']
        };

        const $ = id => document.getElementById(id);
        const canvas = $('canvas');
        const ctx = canvas.getContext('2d');

        function init() {
            $('uploadArea').onclick = () => $('audioFile').click();
            $('uploadArea').ondragover = e => { e.preventDefault(); $('uploadArea').classList.add('dragover'); };
            $('uploadArea').ondragleave = () => $('uploadArea').classList.remove('dragover');
            $('uploadArea').ondrop = e => {
                e.preventDefault();
                $('uploadArea').classList.remove('dragover');
                if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
            };
            $('audioFile').onchange = e => e.target.files[0] && handleFile(e.target.files[0]);
            
            $('colorMode').onchange = e => {
                $('solidColor').style.display = e.target.value === 'solid' ? 'flex' : 'none';
                $('customGradient').style.display = e.target.value === 'custom' ? 'block' : 'none';
                updatePreview();
            };
            
            ['waveColor', 'bgColor', 'width', 'height', 'style', 'smoothing', 'opacity', 'c1', 'c2', 'c3', 'c4', 'c5', 'use3', 'use4', 'use5'].forEach(id => {
                const el = $(id);
                if (el) {
                    el.onchange = el.oninput = () => {
                        saveState();
                        updatePreview();
                        if (id === 'smoothing') $('smoothVal').textContent = el.value;
                        if (id === 'opacity') $('opacVal').textContent = el.value;
                    };
                }
            });

            $('generateBtn').onclick = generate;
            $('downloadBtn').onclick = download;
            $('copyBtn').onclick = copyToClipboard;
            $('darkBtn').onclick = () => {
                document.body.classList.toggle('dark-mode');
                $('darkBtn').textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('dark', document.body.classList.contains('dark-mode'));
            };
            $('undoBtn').onclick = undo;
            $('redoBtn').onclick = redo;

            if (localStorage.getItem('dark') === 'true') {
                document.body.classList.add('dark-mode');
                $('darkBtn').textContent = '‚òÄÔ∏è';
            }

            document.onkeydown = e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
            };

            updatePreview();
        }

        async function handleFile(file) {
            if (!file.type.startsWith('audio/')) return showStatus('Invalid file', 'error');
            showStatus('Processing...', 'processing');
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buf = await file.arrayBuffer();
                state.buffer = await ctx.decodeAudioData(buf);
                showStatus('Loaded!', 'success');
                $('generateBtn').disabled = false;
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
            }
        }

        function getColors() {
            const mode = $('colorMode').value;
            if (mode === 'solid') return null;
            if (presets[mode]) return presets[mode];
            if (mode === 'custom') {
                const colors = [$('c1').value, $('c2').value];
                if ($('use3').checked) colors.push($('c3').value);
                if ($('use4').checked) colors.push($('c4').value);
                if ($('use5').checked) colors.push($('c5').value);
                return colors;
            }
            return null;
        }

        function updatePreview() {
            const colors = getColors();
            if (colors) {
                $('preview').style.background = 'linear-gradient(to right, ' + colors.join(', ') + ')';
                $('preview').style.display = 'block';
            } else {
                $('preview').style.display = 'none';
            }
        }

        function generate() {
            if (!state.buffer) return;
            showStatus('Generating...', 'processing');
            
            const w = parseInt($('width').value);
            const h = parseInt($('height').value);
            const style = $('style').value;
            const smooth = parseInt($('smoothing').value);
            const alpha = parseInt($('opacity').value) / 100;

            canvas.width = w;
            canvas.height = h;

            ctx.fillStyle = $('bgColor').value;
            ctx.fillRect(0, 0, w, h);

            const data = state.buffer.getChannelData(0);
            const samples = Math.min(w * smooth / 50, w * 4);
            const block = Math.floor(data.length / samples);
            const filtered = [];

            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < block; j++) sum += Math.abs(data[i * block + j]);
                filtered.push(sum / block);
            }

            const max = Math.max(...filtered, 0.1);
            const norm = filtered.map(v => v / max);

            const colors = getColors();
            ctx.globalAlpha = alpha;
            
            if (colors) {
                const grad = ctx.createLinearGradient(0, 0, w, 0);
                colors.forEach((c, i) => grad.addColorStop(i / (colors.length - 1), c));
                ctx.fillStyle = grad;
                ctx.strokeStyle = grad;
            } else {
                ctx.fillStyle = $('waveColor').value;
                ctx.strokeStyle = $('waveColor').value;
            }

            ctx.lineWidth = 2;

            if (style === 'bars') {
                const bw = Math.max(w / samples, 1);
                for (let i = 0; i < samples; i++) {
                    const bh = norm[i] * h * 0.8;
                    ctx.fillRect(i * bw, (h - bh) / 2, Math.ceil(bw), bh);
                }
            } else if (style === 'roundedBars') {
                const bw = Math.max(w / samples, 1);
                const r = Math.min(bw / 2, 5);
                for (let i = 0; i < samples; i++) {
                    const bh = norm[i] * h * 0.8;
                    const x = i * bw, y = (h - bh) / 2;
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.arcTo(x + Math.ceil(bw), y, x + Math.ceil(bw), y + bh, r);
                    ctx.arcTo(x + Math.ceil(bw), y + bh, x, y + bh, r);
                    ctx.arcTo(x, y + bh, x, y, r);
                    ctx.arcTo(x, y, x + Math.ceil(bw), y, r);
                    ctx.closePath();
                    ctx.fill();
                }
            } else if (style === 'line') {
                ctx.beginPath();
                for (let i = 0; i < samples; i++) {
                    const x = (i / samples) * w;
                    const y = h / 2 - (norm[i] * h * 0.4);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.lineTo(w, h / 2);
                ctx.moveTo(0, h / 2);
                for (let i = 0; i < samples; i++) {
                    const x = (i / samples) * w;
                    const y = h / 2 + (norm[i] * h * 0.4);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.stroke();
            } else if (style === 'mirror') {
                const bw = Math.max(w / samples, 1);
                for (let i = 0; i < samples; i++) {
                    const bh = norm[i] * h * 0.4;
                    const x = i * bw;
                    ctx.fillRect(x, h / 2, Math.ceil(bw), bh);
                    ctx.fillRect(x, h / 2 - bh, Math.ceil(bw), bh);
                }
            } else if (style === 'filled') {
                ctx.beginPath();
                ctx.moveTo(0, h / 2);
                for (let i = 0; i < samples; i++) {
                    ctx.lineTo((i / samples) * w, h / 2 - (norm[i] * h * 0.4));
                }
                ctx.lineTo(w, h / 2);
                ctx.closePath();
                ctx.fill();
            } else if (style === 'particles') {
                for (let i = 0; i < samples; i++) {
                    const x = (i / samples) * w;
                    const amp = norm[i] * h * 0.4;
                    const n = Math.ceil(amp / 10);
                    for (let j = 0; j < n; j++) {
                        const y = h / 2 + (j / n - 0.5) * amp * 2;
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }

            ctx.globalAlpha = 1;
            $('canvasContainer').style.display = 'block';
            $('downloadBtn').disabled = false;
            $('copyBtn').disabled = false;
            showStatus('Done!', 'success');
        }

        function download() {
            const link = document.createElement('a');
            link.download = 'waveform.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showStatus('Downloaded!', 'success');
        }

        async function copyToClipboard() {
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                showStatus('Copied to clipboard!', 'success');
            } catch (error) {
                showStatus('Copy failed - try downloading instead', 'error');
                console.error('Clipboard error:', error);
            }
        }

        function showStatus(msg, type) {
            $('status').textContent = msg;
            $('status').className = 'status ' + type;
            $('status').style.display = 'block';
            if (type === 'success') setTimeout(() => $('status').style.display = 'none', 3000);
        }

        function saveState() {
            const settings = {
                colorMode: $('colorMode').value,
                waveColor: $('waveColor').value,
                bgColor: $('bgColor').value,
                width: $('width').value,
                height: $('height').value,
                style: $('style').value,
                smoothing: $('smoothing').value,
                opacity: $('opacity').value,
                c1: $('c1').value,
                c2: $('c2').value,
                c3: $('c3').value,
                c4: $('c4').value,
                c5: $('c5').value,
                use3: $('use3').checked,
                use4: $('use4').checked,
                use5: $('use5').checked
            };
            state.history = state.history.slice(0, state.historyIdx + 1);
            state.history.push(settings);
            state.historyIdx++;
            if (state.history.length > 50) {
                state.history.shift();
                state.historyIdx--;
            }
            updateHistoryButtons();
        }

        function undo() {
            if (state.historyIdx > 0) {
                state.historyIdx--;
                applySettings(state.history[state.historyIdx]);
                updateHistoryButtons();
            }
        }

        function redo() {
            if (state.historyIdx < state.history.length - 1) {
                state.historyIdx++;
                applySettings(state.history[state.historyIdx]);
                updateHistoryButtons();
            }
        }

        function applySettings(s) {
            $('colorMode').value = s.colorMode;
            $('waveColor').value = s.waveColor;
            $('bgColor').value = s.bgColor;
            $('width').value = s.width;
            $('height').value = s.height;
            $('style').value = s.style;
            $('smoothing').value = s.smoothing;
            $('opacity').value = s.opacity;
            $('c1').value = s.c1;
            $('c2').value = s.c2;
            $('c3').value = s.c3;
            $('c4').value = s.c4;
            $('c5').value = s.c5;
            $('use3').checked = s.use3;
            $('use4').checked = s.use4;
            $('use5').checked = s.use5;
            $('smoothVal').textContent = s.smoothing;
            $('opacVal').textContent = s.opacity;
            $('colorMode').dispatchEvent(new Event('change'));
            updatePreview();
        }

        function updateHistoryButtons() {
            $('undoBtn').disabled = state.historyIdx <= 0;
            $('redoBtn').disabled = state.historyIdx >= state.history.length - 1;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
